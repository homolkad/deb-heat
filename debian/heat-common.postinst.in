#!/bin/sh

set -e

ETC=/etc/heat
CONF=/etc/heat/heat.conf

#PKGOS-INCLUDE#

if [ "$1" = "configure" ] || [ "$1" = "reconfigure" ] ; then
	. /usr/share/debconf/confmodule
	. /usr/share/dbconfig-common/dpkg/postinst

	pkgos_var_user_group heat
	chown heat:adm /var/log/heat
	chmod 0750 /var/log/heat
	mkdir -p /etc/heat
	mkdir -p /var/lib/heat
	chown heat:heat /var/lib/heat /etc/heat
        pkgos_write_new_conf heat heat.conf

	pkgos_dbc_postinst ${CONF} DEFAULT sql_connection heat $@
	pkgos_rabbit_write_conf ${CONF} DEFAULT heat
        pkgos_write_admin_creds ${CONF} keystone_authtoken heat
	pkgos_register_endpoint_postinst heat heat orchestration "Heat Orchestration API" 8004 /v1/'%(tenant_id)s'
	# This is the equivalent of db-sync:
	su heat -c "heat-manage db_sync"

        chown -R heat:adm /var/log/heat
        chmod 0750 /var/log/heat
fi

#DEBHELPER#
